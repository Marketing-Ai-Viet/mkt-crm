# Marketing CRM RBAC (Role-Based Access Control) System

## üéØ T·ªïng Quan

H·ªá th·ªëng RBAC 4 t·∫ßng to√†n di·ªán ƒë∆∞·ª£c thi·∫øt k·∫ø cho n·ªÅn t·∫£ng Marketing CRM, cung c·∫•p ki·ªÉm so√°t quy·ªÅn truy c·∫≠p chi ti·∫øt, b·∫£o m·∫≠t v√† linh ho·∫°t tr√™n nhi·ªÅu c·∫•p ƒë·ªô kh√°c nhau c·ªßa ·ª©ng d·ª•ng.

## üèóÔ∏è Ki·∫øn Tr√∫c 4 T·∫ßng

H·ªá th·ªëng RBAC tri·ªÉn khai m√¥ h√¨nh ph√¢n quy·ªÅn ph√¢n c·∫•p v·ªõi 4 t·∫ßng b·∫£o m·∫≠t ri√™ng bi·ªát:

### üîπ T·∫ßng 1: Ki·ªÉm So√°t Truy C·∫≠p Module
**Component**: `ModuleAccessGuard`  
**Ph·∫°m vi**: C√°c module ·ª©ng d·ª•ng (order, invoice, license, v.v.)  
**M·ª•c ƒë√≠ch**: Ki·ªÉm so√°t ng∆∞·ªùi d√πng c√≥ th·ªÉ truy c·∫≠p c√°c module kinh doanh c·ª• th·ªÉ hay kh√¥ng

```typescript
// V√≠ d·ª•: Ki·ªÉm tra user c√≥ th·ªÉ truy c·∫≠p module Order kh√¥ng
@RequireModuleAccess('order')
@Resolver(() => MktOrder)
export class MktOrderResolver {
  // T·∫•t c·∫£ methods ƒë·ªÅu y√™u c·∫ßu quy·ªÅn truy c·∫≠p Order module
}
```

**T√≠nh nƒÉng:**
- T·ª± ƒë·ªông ph√°t hi·ªán module t·ª´ t√™n resolver class
- Y√™u c·∫ßu module r√µ r√†ng qua decorators
- Thi·∫øt k·∫ø fail-safe (cho ph√©p truy c·∫≠p n·∫øu kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c module)

### üî∏ T·∫ßng 2: Quy·ªÅn T·∫°m Th·ªùi (∆Øu ti√™n cao nh·∫•t)
**Component**: `MktTemporaryPermissionWorkspaceEntity`  
**Ph·∫°m vi**: Quy·ªÅn gi·ªõi h·∫°n th·ªùi gian, chi ti·∫øt  
**M·ª•c ƒë√≠ch**: Truy c·∫≠p kh·∫©n c·∫•p, ·ªßy quy·ªÅn, k·ªãch b·∫£n break-glass

```typescript
// V√≠ d·ª• truy c·∫≠p kh·∫©n c·∫•p
const emergencyPermission = {
  granteeWorkspaceMemberId: "support-agent-id",
  objectName: "mktOrder",
  recordId: "urgent-order-id", // Ch·ªâ record c·ª• th·ªÉ
  canRead: true,
  canUpdate: true,
  expiresAt: new Date(Date.now() + 2*60*60*1000), // 2 gi·ªù
  reason: "Khi·∫øu n·∫°i kh√°ch h√†ng - y√™u c·∫ßu c·ªßa CEO"
}
```

**T√≠nh nƒÉng ch√≠nh:**
- **Override Authority**: Bypass t·∫•t c·∫£ c√°c t·∫ßng quy·ªÅn kh√°c
- **Ki·ªÉm so√°t th·ªùi gian**: T·ª± ƒë·ªông h·∫øt h·∫°n
- **Ph·∫°m vi chi ti·∫øt**: Truy c·∫≠p c·∫•p object ho·∫∑c record c·ª• th·ªÉ
- **Audit trail ƒë·∫ßy ƒë·ªß**: Theo d√µi ai, g√¨, khi n√†o, t·∫°i sao
- **H·ªó tr·ª£ thu h·ªìi**: C√≥ th·ªÉ thu h·ªìi tr∆∞·ªõc khi h·∫øt h·∫°n

**Use Cases:**
- Truy c·∫≠p kh·∫©n c·∫•p break-glass
- ·ª¶y quy·ªÅn manager khi v·∫Øng m·∫∑t
- Khi·∫øu n·∫°i h·ªó tr·ª£ kh√°ch h√†ng
- Audit tu√¢n th·ªß quy ƒë·ªãnh
- Tri·ªÉn khai zero standing privileges

### üîπ T·∫ßng 3: Ch√≠nh S√°ch Truy C·∫≠p D·ªØ Li·ªáu
**Component**: `MktDataAccessPolicyWorkspaceEntity`  
**Ph·∫°m vi**: Quy·ªÅn c·∫•p object v·ªõi ƒëi·ªÅu ki·ªán l·ªçc  
**M·ª•c ƒë√≠ch**: Ki·ªÉm so√°t truy c·∫≠p d·ª±a tr√™n role v√† department

```typescript
// Ch√≠nh s√°ch truy c·∫≠p d·ª±a tr√™n department
const salesPolicy = {
  name: "Sales Team Order Access",
  objectName: "mktOrder",
  departmentId: "sales-dept-id",
  priority: 100,
  filterConditions: {
    "assignedSalesRep": "{user.workspaceMemberId}"
  },
  isActive: true
}
```

**T√≠nh nƒÉng:**
- Quy·ªÅn d·ª±a tr√™n department
- G√°n user c√° nh√¢n
- ƒêi·ªÅu ki·ªán l·ªçc JSON cho ki·ªÉm so√°t truy c·∫≠p ƒë·ªông
- ƒê√°nh gi√° policy d·ª±a tr√™n priority
- H·ªó tr·ª£ quy t·∫Øc kinh doanh ph·ª©c t·∫°p

### üîπ T·∫ßng 4: Quy·ªÅn C·∫•p Field
**Component**: `GraphQLFieldPermissionInterceptor`  
**Ph·∫°m vi**: C√°c field ri√™ng l·∫ª trong objects  
**M·ª•c ƒë√≠ch**: B·∫£o v·ªá d·ªØ li·ªáu nh·∫°y c·∫£m v√† ki·ªÉm so√°t truy c·∫≠p c·∫•p field

```typescript
// V√≠ d·ª• l·ªçc c·∫•p field
const orderData = {
  id: "order-123",
  customerName: "John Doe",
  totalAmount: 1000,      // ‚ùå ·∫®n v·ªõi junior sales
  internalNotes: "...",   // ‚ùå ·∫®n v·ªõi external users
  status: "processing"    // ‚úÖ Hi·ªÉn th·ªã cho t·∫•t c·∫£
}
```

**T√≠nh nƒÉng:**
- T·ª± ƒë·ªông l·ªçc field trong GraphQL responses
- Hi·ªÉn th·ªã field d·ª±a tr√™n role
- B·∫£o v·ªá d·ªØ li·ªáu nh·∫°y c·∫£m
- L·ªçc t·ªëi ∆∞u hi·ªáu nƒÉng

## üîÑ Lu·ªìng Ph√¢n Gi·∫£i Quy·ªÅn

```mermaid
graph TD
    A[Request Received] --> B[T·∫ßng 1: Module Access Check]
    B -->|DENIED| E[403 Forbidden]
    B -->|GRANTED| C[T·∫ßng 2: Check Temporary Permissions]
    C -->|FOUND & VALID| D[GRANTED - Bypass other layers]
    C -->|NOT FOUND| F[T·∫ßng 3: Check Data Access Policies]
    F -->|FOUND & MATCH| G[GRANTED with Policy Rules]
    F -->|NOT FOUND| H[DEFAULT DENY]
    D --> I[T·∫ßng 4: Apply Field-Level Filtering]
    G --> I
    H --> E
    I --> J[Return Filtered Response]
```

## üõ°Ô∏è Nguy√™n T·∫Øc B·∫£o M·∫≠t

### 1. **Defense in Depth**
M·ªói t·∫ßng cung c·∫•p m·ªôt lo·∫°i b·∫£o v·ªá kh√°c nhau:
- T·∫ßng 1: Truy c·∫≠p module th√¥ s∆°
- T·∫ßng 2: Override kh·∫©n c·∫•p v·ªõi gi·ªõi h·∫°n th·ªùi gian
- T·∫ßng 3: Th·ª±c thi quy t·∫Øc kinh doanh
- T·∫ßng 4: B·∫£o v·ªá ƒë·ªô nh·∫°y c·∫£m d·ªØ li·ªáu

### 2. **Nguy√™n T·∫Øc Quy·ªÅn T·ªëi Thi·ªÉu**
- Users b·∫Øt ƒë·∫ßu v·ªõi quy·ªÅn t·ªëi thi·ªÉu
- Quy·ªÅn t·∫°m th·ªùi cho c√°c t√°c v·ª• c·ª• th·ªÉ
- T·ª± ƒë·ªông h·∫øt h·∫°n truy c·∫≠p n√¢ng cao
- Ki·ªÉm so√°t chi ti·∫øt c·∫•p record

### 3. **Zero Trust Architecture**
- M·ªçi request ƒë·ªÅu ƒë∆∞·ª£c x√°c th·ª±c v√† ·ªßy quy·ªÅn
- Kh√¥ng c√≥ trust ng·∫ßm ƒë·ªãnh d·ª±a tr√™n v·ªã tr√≠ m·∫°ng
- Audit logging to√†n di·ªán
- ƒê√°nh gi√° quy·ªÅn ƒë·ªông

### 4. **Fail-Safe Defaults**
- M·∫∑c ƒë·ªãnh DENY khi policies kh√¥ng r√µ r√†ng
- Degradation graceful khi services kh√¥ng kh·∫£ d·ª•ng
- X·ª≠ l√Ω l·ªói v√† logging to√†n di·ªán

## üìä C√°c Component C·ªët L√µi

### Services
- **`MktRbacService`**: Service ki·ªÉm tra quy·ªÅn trung t√¢m
- **`PermissionContextService`**: Tr√≠ch xu·∫•t v√† validation context
- **`RbacContextEnrichmentMiddleware`**: T·ªëi ∆∞u hi·ªáu nƒÉng qua caching

### Guards
- **`ModuleAccessGuard`**: B·∫£o v·ªá t·∫ßng 1
- **`GraphQLPermissionGuard`**: Ki·ªÉm so√°t truy c·∫≠p GraphQL t·ªïng qu√°t
- **`ActionPermissionGuard`**: Ki·ªÉm tra quy·ªÅn c·ª• th·ªÉ theo action

### Entities
- **`MktTemporaryPermissionWorkspaceEntity`**: L∆∞u tr·ªØ quy·ªÅn t·∫°m th·ªùi
- **`MktDataAccessPolicyWorkspaceEntity`**: ƒê·ªãnh nghƒ©a policies
- **`MktPermissionAuditWorkspaceEntity`**: L∆∞u tr·ªØ audit trail

### Interceptors
- **`GraphQLFieldPermissionInterceptor`**: L·ªçc c·∫•p field
- **`SensitiveFieldHidingInterceptor`**: B·∫£o v·ªá PII t·ª± ƒë·ªông
- **`DataOwnershipInterceptor`**: Ki·ªÉm so√°t truy c·∫≠p d·ª±a tr√™n ownership

## üöÄ T·ªëi ∆Øu Hi·ªáu NƒÉng

### 1. **Permission Caching**
```typescript
// Middleware pre-loads c√°c quy·ªÅn th√¥ng d·ª•ng
req.rbacContext = {
  commonPermissions: [...],     // Quy·ªÅn ƒë√£ pre-load
  permissionCache: new Map(),   // Runtime cache
  userRoleInfo: {...}          // User context
}
```

### 2. **Smart Auto-Detection**
```typescript
// Guards t·ª± ƒë·ªông ph√°t hi·ªán modules c·∫ßn thi·∫øt
const patterns = [
  /^Mkt(\w+)Resolver$/,  // MktOrderResolver -> order
  /^(\w+)Resolver$/,     // OrderResolver -> order
]
```

### 3. **Batch Permission Checks**
```typescript
const results = await rbacService.checkMultiplePermissions([
  { action: 'QUERY', objectName: 'mktOrder' },
  { action: 'MUTATION', objectName: 'mktInvoice' }
])
```

## üîß C·∫•u H√¨nh

### Module Registration
```typescript
@Module({
  imports: [
    // Business modules tr∆∞·ªõc
    MktOrderModule,
    MktInvoiceModule,  
    MktLicenseModule,
    
    // RBAC module cu·ªëi c√πng cho DI ƒë√∫ng
    MktRbacModule.forRoot(),
  ],
})
export class MktCoreModule {}
```

### Middleware Setup
```typescript
// RBAC enrichment ch·∫°y sau authentication
consumer
  .apply(RbacContextEnrichmentMiddleware)
  .forRoutes({ path: 'graphql', method: RequestMethod.ALL });
```

## üìã V√≠ D·ª• S·ª≠ D·ª•ng

### 1. B·∫£o V·ªá Module C∆° B·∫£n
```typescript
@RequireModuleAccess('order')
@Resolver(() => MktOrder)
export class MktOrderResolver {
  @Query(() => [MktOrder])
  getMktOrders(): Promise<MktOrder[]> {
    // T·ª± ƒë·ªông b·∫£o v·ªá b·ªüi ModuleAccessGuard
    return this.orderService.findAll();
  }
}
```

### 2. Truy C·∫≠p T·∫°m Th·ªùi Kh·∫©n C·∫•p
```typescript
// C·∫•p quy·ªÅn truy c·∫≠p kh·∫©n c·∫•p
await temporaryPermissionService.create({
  granteeWorkspaceMemberId: userId,
  objectName: 'mktOrder',
  canRead: true,
  canUpdate: true,
  expiresAt: new Date(Date.now() + 60*60*1000), // 1 gi·ªù
  reason: 'Gi·∫£i quy·∫øt khi·∫øu n·∫°i kh√°ch h√†ng',
  granterWorkspaceMemberId: managerId
});
```

### 3. Ki·ªÉm Tra Quy·ªÅn T√πy Ch·ªânh
```typescript
const hasPermission = await rbacService.checkPermission({
  action: 'MUTATION',
  objectName: 'mktOrder',
  recordId: orderId,
  workspaceMemberId: userId,
  workspaceId: workspaceId
});

if (hasPermission.result !== 'GRANTED') {
  throw new ForbiddenException('Truy c·∫≠p b·ªã t·ª´ ch·ªëi');
}
```

## üîç Audit & Compliance

### C·∫•u Tr√∫c Audit Trail
```typescript
interface PermissionAudit {
  workspaceMemberId: string;
  action: PermissionAuditAction;
  objectName: string;
  recordId?: string;
  permissionSource: PermissionSource;
  checkResult: CheckResult;
  checkDurationMs: number;
  denialReason?: string;
  requestContext: {
    ipAddress?: string;
    userAgent?: string;
    sessionId?: string;
    metadata?: any;
  };
}
```

### T√≠nh NƒÉng Compliance
- **SOX Compliance**: Audit trail ƒë·∫ßy ƒë·ªß v·ªÅ ai truy c·∫≠p d·ªØ li·ªáu g√¨
- **GDPR Compliance**: L√Ω do cho vi·ªác truy c·∫≠p d·ªØ li·ªáu v·ªõi gi·ªõi h·∫°n th·ªùi gian
- **Internal Audit**: Qu·∫£n l√Ω quy·ªÅn v√† ·ªßy quy·ªÅn minh b·∫°ch
- **Security Monitoring**: Logging ki·ªÉm tra quy·ªÅn real-time

## T√≠nh nƒÉng

- **Decorators Quy·ªÅn GraphQL Chuy√™n Bi·ªát**: B·∫£o v·ªá resolvers, mutations, subscriptions v√† fields
- **Ki·ªÉm So√°t Quy·ªÅn C·∫•p Field**: Ki·ªÉm so√°t truy c·∫≠p ƒë·∫øn t·ª´ng GraphQL field ri√™ng bi·ªát  
- **Audit Logging To√†n Di·ªán**: M·ªçi ki·ªÉm tra quy·ªÅn ƒë·ªÅu ƒë∆∞·ª£c ghi log v√†o `mktPermissionAudit`
- **ƒêa Ngu·ªìn C·∫•p Quy·ªÅn**: H·ªó tr·ª£ quy·ªÅn d·ª±a tr√™n role, policy v√† quy·ªÅn t·∫°m th·ªùi
- **Theo D√µi Context GraphQL**: T·ª± ƒë·ªông tr√≠ch xu·∫•t metadata c·ªßa GraphQL operation ƒë·ªÉ ph√¢n t√≠ch b·∫£o m·∫≠t
- **T·ªëi ∆Øu Hi·ªáu NƒÉng**: Caching th√¥ng minh v√† ki·ªÉm tra quy·ªÅn h√†ng lo·∫°t
- **Gi√°m S√°t B·∫£o M·∫≠t Th·ªùi Gian Th·ª±c**: T√≠ch h·ª£p s·∫µn gi√°m s√°t GraphQL operation v√† ph√°t hi·ªán m·ªëi ƒëe d·ªça

## B·∫Øt ƒê·∫ßu Nhanh

### 1. GraphQL Resolver C∆° B·∫£n v·ªõi Quy·ªÅn

```typescript
import { Resolver, Query, Mutation, Args, ResolveField, Parent } from '@nestjs/graphql';
import { RequireQuery, RequireCreateMutation, RequireFieldRead } from 'src/mkt-core/mkt-rbac';

@Resolver(() => MktKpi)
export class MktKpiResolver {
  @Query(() => [MktKpi])
  @RequireQueryList('mktKpi')
  async findMktKpis(): Promise<MktKpi[]> {
    // User ph·∫£i c√≥ quy·ªÅn QUERY tr√™n mktKpi
    return this.kpiService.findAll();
  }

  @Query(() => MktKpi, { nullable: true })
  @RequireQuery('mktKpi', 'id')
  async findMktKpi(@Args('id') id: string): Promise<MktKpi | null> {
    // User ph·∫£i c√≥ quy·ªÅn QUERY tr√™n record KPI c·ª• th·ªÉ
    return this.kpiService.findById(id);
  }

  @Mutation(() => MktKpi)
  @RequireCreateMutation('mktKpi')
  async createMktKpi(@Args('input') input: CreateMktKpiInput): Promise<MktKpi> {
    // User ph·∫£i c√≥ quy·ªÅn MUTATION tr√™n mktKpi
    return this.kpiService.create(input);
  }

  @ResolveField(() => String, { nullable: true })
  @RequireFieldRead('sensitiveData', 'mktKpi', true)
  async sensitiveData(@Parent() kpi: MktKpi): Promise<string | null> {
    // User ph·∫£i c√≥ quy·ªÅn FIELD_READ cho field c·ª• th·ªÉ n√†y
    return kpi.sensitiveData;
  }
}
```

### 2. Ki·ªÉm Tra Quy·ªÅn Theo Ch∆∞∆°ng Tr√¨nh

```typescript
import { Injectable } from '@nestjs/common';
import { MktRbacService, PermissionContext } from 'src/mkt-core/mkt-rbac';

@Injectable()
export class MyService {
  constructor(private readonly rbacService: MktRbacService) {}

  async checkUserAccess(userId: string, workspaceId: string): Promise<boolean> {
    const context: PermissionContext = {
      action: 'QUERY',
      operationType: 'query',
      operationName: 'findMktKpi',
      objectName: 'mktKpi',
      workspaceMemberId: userId,
      workspaceId: workspaceId,
    };

    const result = await this.rbacService.checkPermission(context);
    return result.result === 'GRANTED';
  }
}
```

## C√°c Decorators GraphQL C√≥ S·∫µn

### Query Decorators
- `@RequireQuery(objectName, recordIdVariable?)` - Y√™u c·∫ßu quy·ªÅn QUERY
- `@RequireQueryList(objectName)` - Y√™u c·∫ßu quy·ªÅn QUERY ƒë·ªÉ li·ªát k√™

### Mutation Decorators
- `@RequireMutation(objectName, recordIdVariable?, requireOwnership?)` - Quy·ªÅn mutation t·ªïng qu√°t
- `@RequireCreateMutation(objectName)` - Y√™u c·∫ßu quy·ªÅn MUTATION ƒë·ªÉ t·∫°o
- `@RequireUpdateMutation(objectName, recordIdVariable)` - Y√™u c·∫ßu quy·ªÅn MUTATION ƒë·ªÉ c·∫≠p nh·∫≠t
- `@RequireDeleteMutation(objectName, recordIdVariable)` - Y√™u c·∫ßu quy·ªÅn MUTATION ƒë·ªÉ x√≥a

### Subscription Decorators
- `@RequireSubscription(objectName)` - Y√™u c·∫ßu quy·ªÅn SUBSCRIPTION

### Field-Level Decorators
- `@RequireFieldRead(fieldName, objectName, allowNull?)` - Y√™u c·∫ßu quy·ªÅn FIELD_READ
- `@RequireFieldWrite(fieldName, objectName)` - Y√™u c·∫ßu quy·ªÅn FIELD_WRITE
- `@RequireSensitiveField(fieldName, objectName, defaultValue?)` - Cho c√°c field nh·∫°y c·∫£m v·ªõi gi√° tr·ªã m·∫∑c ƒë·ªãnh

### Advanced GraphQL Permission Decorator
```typescript
@RequireGraphQLPermission({
  action: 'QUERY',
  objectName: 'mktKpi',
  operationType: 'query',
  recordIdVariable: 'id',
  allowPartial: true,     // Cho ph√©p truy c·∫≠p m·ªôt ph·∫ßn field
  skipAudit: false,       // C√≥ b·ªè qua audit logging kh√¥ng
  requireOwnership: true  // Ki·ªÉm tra xem user c√≥ s·ªü h·ªØu record kh√¥ng
})
```

## Ngu·ªìn C·∫•p Quy·ªÅn (Theo Th·ª© T·ª± ∆Øu Ti√™n)

1. **Quy·ªÅn T·∫°m Th·ªùi** - Quy·ªÅn gi·ªõi h·∫°n th·ªùi gian v·ªõi ng√†y h·∫øt h·∫°n
2. **Ch√≠nh S√°ch Truy C·∫≠p D·ªØ Li·ªáu** - Quy·ªÅn d·ª±a tr√™n policy linh ho·∫°t v·ªõi ƒëi·ªÅu ki·ªán
3. **Quy·ªÅn D·ª±a Tr√™n Role** - Quy·ªÅn truy c·∫≠p d·ª±a tr√™n role truy·ªÅn th·ªëng (m·∫∑c ƒë·ªãnh t·ª´ ch·ªëi)

## Audit Logging

M·ªçi ki·ªÉm tra quy·ªÅn ƒë·ªÅu ƒë∆∞·ª£c t·ª± ƒë·ªông ghi log v√†o entity `mktPermissionAudit` v·ªõi:

- **Chi Ti·∫øt Action**: Action g√¨ ƒë∆∞·ª£c th·ª≠ tr√™n object n√†o
- **Context User**: Ai th·ª±c hi·ªán request v√† t·ª´ ƒë√¢u
- **K·∫øt Qu·∫£**: Truy c·∫≠p ƒë∆∞·ª£c c·∫•p/t·ª´ ch·ªëi v√† t·∫°i sao
- **Metrics Hi·ªáu NƒÉng**: Ki·ªÉm tra quy·ªÅn m·∫•t bao l√¢u
- **Context B·∫£o M·∫≠t**: ƒê·ªãa ch·ªâ IP, user agent, chi ti·∫øt request
- **Metadata**: Context b·ªï sung v·ªÅ operation

## T√≠nh NƒÉng B·∫£o M·∫≠t

### Ph√°t Hi·ªán M·ªëi ƒêe D·ªça
H·ªá th·ªëng t·ª± ƒë·ªông ph√°t hi·ªán v√† ghi log:
- C√°c c·ªë g·∫Øng SQL injection trong query parameters
- C√°c c·ªë g·∫Øng XSS trong request data
- User agents ƒë√°ng ng·ªù
- Ph√°t hi·ªán s·ª≠ d·ª•ng proxy

### Fingerprinting Request
M·ªói request c√≥ m·ªôt fingerprint duy nh·∫•t ƒë·ªÉ ph√¢n t√≠ch b·∫£o m·∫≠t d·ª±a tr√™n:
- ƒê·ªãa ch·ªâ IP client
- User agent
- Accept-Language header

### V·ªá Sinh D·ªØ Li·ªáu
- D·ªØ li·ªáu nh·∫°y c·∫£m t·ª± ƒë·ªông b·ªã che trong logs
- Payload l·ªõn b·ªã c·∫Øt ng·∫Øn
- ƒê·ªãnh danh c√° nh√¢n b·ªã che m·ªôt ph·∫ßn

## C·∫•u H√¨nh

### B·ªè Qua Audit Logging
Cho c√°c endpoint quan tr·ªçng v·ªÅ hi·ªáu nƒÉng:
```typescript
@RequireGraphQLPermission({ 
  action: 'QUERY', 
  objectName: 'mktKpi',
  skipAudit: true 
})
```

### Cho Ph√©p Truy C·∫≠p M·ªôt Ph·∫ßn
Cho quy·ªÅn c·∫•p field:
```typescript
@RequireGraphQLPermission({ 
  action: 'QUERY', 
  objectName: 'mktKpi',
  allowPartial: true 
})
async getPartialData() {
  const context = this.permissionContext.getContext();
  const result = context?.getPermissionResult();
  
  if (result?.result === 'PARTIAL') {
    // Ch·ªâ tr·∫£ v·ªÅ c√°c field ƒë∆∞·ª£c ph√©p
    return { allowedFields: result.grantedFields };
  }
}
```

## T√≠ch H·ª£p v·ªõi Middleware

H·ªá th·ªëng bao g·ªìm middleware t·ª± ƒë·ªông:
- Log t·∫•t c·∫£ API requests v·ªõi permission context
- Ph√°t hi·ªán lo·∫°i operation t·ª´ REST v√† GraphQL endpoints
- Cung c·∫•p audit trail chi ti·∫øt cho ph√¢n t√≠ch b·∫£o m·∫≠t

## C√¢n Nh·∫Øc Hi·ªáu NƒÉng

- K·∫øt qu·∫£ permission ƒë∆∞·ª£c cache m·ªói request
- Ki·ªÉm tra quy·ªÅn h√†ng lo·∫°t ƒë∆∞·ª£c t·ªëi ∆∞u
- Audit logging l√† b·∫•t ƒë·ªìng b·ªô n·∫øu c√≥ th·ªÉ
- Database queries ƒë∆∞·ª£c t·ªëi ∆∞u v·ªõi indexing th√≠ch h·ª£p

## X·ª≠ L√Ω L·ªói

### T·ª´ Ch·ªëi Quy·ªÅn
```json
{
  "statusCode": 403,
  "message": "Insufficient permissions",
  "reason": "No explicit permission found - default deny",
  "action": "QUERY",
  "objectName": "mktKpi",
  "operationName": "findMktKpi"
}
```

### Y√™u C·∫ßu X√°c Th·ª±c
```json
{
  "statusCode": 401,
  "message": "Authentication required"
}
```

## V√≠ D·ª•

Xem `src/mkt-core/mkt-rbac/examples/mkt-kpi-graphql.example.ts` ƒë·ªÉ c√≥ v√≠ d·ª• s·ª≠ d·ª•ng to√†n di·ªán bao g·ªìm:
- C√°c operation CRUD c∆° b·∫£n v·ªõi ki·ªÉm tra quy·ªÅn
- X·ª≠ l√Ω truy c·∫≠p m·ªôt ph·∫ßn
- X√°c minh quy·ªÅn th·ªß c√¥ng
- L√†m ph√π metadata audit

## Ki·∫øn Tr√∫c

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Decorators    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ   GraphQL        ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ   RBAC Service      ‚îÇ
‚îÇ   (@Require*)   ‚îÇ    ‚îÇ   Permission     ‚îÇ    ‚îÇ   (Logic C·ªët L√µi)   ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ   Guard          ‚îÇ    ‚îÇ                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                       ‚îÇ                        ‚îÇ
         ‚îÇ                       ‚îÇ                        ‚îÇ
         ‚ñº                       ‚ñº                        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Permission    ‚îÇ    ‚îÇ   Field          ‚îÇ    ‚îÇ   Audit Logging     ‚îÇ
‚îÇ   Context       ‚îÇ    ‚îÇ   Permission     ‚îÇ    ‚îÇ   (mktPermission    ‚îÇ
‚îÇ   Service       ‚îÇ    ‚îÇ   Interceptor    ‚îÇ    ‚îÇ   Audit)            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

H·ªá th·ªëng ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ:
- **Kh√¥ng X√¢m L·∫•n**: Ho·∫°t ƒë·ªông v·ªõi controllers hi·ªán c√≥ th√¥ng qua decorators
- **To√†n Di·ªán**: Bao ph·ªß t·∫•t c·∫£ c√°c kh√≠a c·∫°nh qu·∫£n l√Ω quy·ªÅn
- **C√≥ Th·ªÉ Audit**: Trail ƒë·∫ßy ƒë·ªß c·ªßa t·∫•t c·∫£ c·ªë g·∫Øng truy c·∫≠p
- **Hi·ªáu NƒÉng Cao**: T·ªëi ∆∞u cho s·ª≠ d·ª•ng production
- **B·∫£o M·∫≠t**: T√≠ch h·ª£p s·∫µn ph√°t hi·ªán m·ªëi ƒëe d·ªça v√† b·∫£o v·ªá d·ªØ li·ªáu

## L∆∞u √ù S·ª≠ D·ª•ng

1. **Lu√¥n s·ª≠ d·ª•ng decorators**: Thay v√¨ ki·ªÉm tra quy·ªÅn th·ªß c√¥ng, s·ª≠ d·ª•ng decorators ƒë·ªÉ b·∫£o v·ªá resolvers
2. **Field-level security**: S·ª≠ d·ª•ng `@RequireFieldRead` cho d·ªØ li·ªáu nh·∫°y c·∫£m
3. **Audit everything**: C√°c operation quan tr·ªçng lu√¥n ƒë∆∞·ª£c audit t·ª± ƒë·ªông
4. **Handle partial access**: X·ª≠ l√Ω tr∆∞·ªùng h·ª£p user ch·ªâ c√≥ quy·ªÅn truy c·∫≠p m·ªôt ph·∫ßn d·ªØ li·ªáu
5. **Monitor security**: Theo d√µi logs ƒë·ªÉ ph√°t hi·ªán c√°c c·ªë g·∫Øng truy c·∫≠p b·∫•t th∆∞·ªùng

H·ªá th·ªëng RBAC MKT cung c·∫•p b·∫£o m·∫≠t to√†n di·ªán cho GraphQL APIs v·ªõi kh·∫£ nƒÉng ki·ªÉm so√°t chi ti·∫øt t·ª´ operation-level ƒë·∫øn field-level!